<!doctype html>
<html lang="en">
<head>
	<meta charset="utf8">
	<title>前端日志分析</title>
	<style>
		*{margin: 0; padding: 0; color: #333; font-size: 12px; font-family: '微软雅黑', 'Courier New', Courier, monospace;}
		ul,li{list-style: none}
		.red{
			color: #f00;
			font-weight: 700;
			padding-right: 3px;
		}
		.layout-box{
			width: 100%;
			margin-bottom: 20px;
			padding: 10px;
			box-sizing: border-box;
		}
		.title{
			font-size: 20px; font-weight: 700;
			margin-bottom: 20px;
			display: flex;
		}
		.row-box{
			display: flex;
			border-right: 1px solid #ddd;
		}
		.header{
			background: #f0f0f0;
		}
		.header .row{
			font-weight: 700;
			border-top: 1px solid #ddd;
		}
		.row{
			border-left: 1px solid #ddd;
			border-bottom: 1px solid #ddd;
			line-height: 22px;
			padding: 8px 5px;
			flex: 1;
			text-align: center;
			word-wrap: break-word;
			word-break: break-all;	
		}
		.stack{
			cursor: pointer;
		}

		.stack-row-box{
			max-height: 200px;
			overflow: auto;
		}
		.stack-row-box .row{
			text-align: left;
		}

		.search{
			/* display: flex;
			flex-direction: column; */
		}
		.search .label {
			display: inline-block;
			width: 250px;
			text-align: right;
			margin-bottom: 10px;
		}
		input {
			width: 150px;
			height: 30px;
			line-height: 30px;
			border: 1px solid #ddd;
			border-radius: 3px;
			margin-top: 10px;
			padding-left: 10px;

			flex-direction: row;
            flex-wrap: wrap;
			flex: 1;
		}
		select{
			height: 30px;
			line-height: 30px;
			border-radius: 3px;
			padding: 0 10px;
			width: 160px;
			border: 1px solid #ddd;
		}
		.query{
			cursor: pointer;
			color: red;
			font-size: 14px; font-weight: 700;
			border: 1px solid red;
			border-radius: 3px;
			height: 30px;
			padding: 0 10px;
			line-height: 30px;
			box-sizing: border-box;
			display: inline-block;
		}
		.cancel{
			color: #333;
			border: 1px solid #ddd;
		}
		.cheart {
			margin-top: 20px;
			height: 300px;
		}

		.bg2{
			background: #f0f0f0;
			height: 20px;
		}
		.hide{
			display: none!important
		}

		.form-box{
			position: fixed;
			z-index: 9;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.4);
			display: flex;
			align-items: center;
			justify-content: center;
		}
		.form-box .content{
			width: 70%;
			margin: 0 auto;
			background: #fff;
			padding: 20px;
			box-sizing: border-box;
		}

		.form-box .content .add-title{
			font-size: 14px;
			font-weight: 700;
		}
		.form-box .content .label{
			margin-top: 20px;
			text-align: center;
		}
	</style>
</head>
<body>

<div class="layout-box" id="fe">
	<div class="title">错误日志</div>
	<div class="search">
		<div class="label">
			<span class="red">*</span>应用名:
			<select name="app_name" class="search_name">
				<option value="YouPin">优品</option>
				<option value="ZiYou">自有</option>
			</select>
		</div>
		<div class="label">用户id: <input name="user_id" type="text" class="search_name" value="YSG123456" /></div>
		<div class="label"><span class="red">*</span>开始时间: <input name="start_time" type="text" class="search_name" value="2019-07-20" /></div>
		<div class="label"><span class="red">*</span>结束时间: <input name="end_time" type="text" class="search_name" value="2019-07-26" /></div>
		<div class="label">
			<span class="query" onclick="getFeList()">查询</span>&nbsp;
			<span class="query cancel" onclick="openCraetePop('#fe')">创建</span>
		</div>
	</div>

	<div class="form-box hide">
		<div>
			<div class="content">
				<div class="add-title">添加内容</div>
				<select name="app_name" class="search_name">
					<option value="">--请选择--</option>
					<option value="YouPin">优品</option>
					<option value="ZiYou">自有</option>
				</select>
				<input name="user_id" class="search_name" type="text" value="" placeholder="用户id或唯一标识" />
				<input name="url" class="search_name" type="text" value="" placeholder="错误页面的url" />
				<input name="file" class="search_name" type="text" value=""  placeholder="错误的文件"/>
				<input name="line" class="search_name" type="text" value="" placeholder="错误行号" />
				<input name="message" class="search_name" type="text" value="" placeholder="错误信息" />
				<input name="stack" class="search_name" type="text" value="" placeholder="错误调用栈" />
				<div class="label">
					<span class="query" onclick="createErrorReport()">确定</span>&nbsp;
					<span class="query cancel" onclick="openCraetePop('#fe')">取消</span>
				</div>
			</div>
		</div>
	</div>

	<div id="fe-header"></div>
	<div id="fe-content"></div>
	<div id="fe-cheart" class="cheart"></div>
</div>

<div class="bg2"></div>

<div class="layout-box" id="fp">
	<div class="title">资源性能</div>
	<div class="search">
		<div class="label">
			<span class="red">*</span>应用名: 
			<select name="app_name" class="search_name">
				<option value="YouPin">优品</option>
				<option value="ZiYou">自有</option>
			</select>
		</div>
		<div class="label">用户id: <input name="user_id" type="text" class="search_name" value="YSG123456" /></div>
		<div class="label"><span class="red">*</span>开始时间: <input name="start_time" type="text" class="search_name" value="2019-07-20" /></div>
		<div class="label"><span class="red">*</span>结束时间: <input name="end_time" type="text" class="search_name" value="2019-07-26" /></div>
		<div class="label">城市: <input name="city" type="text" class="search_name" value="深圳市" placeholder="比如：深圳市" /></div>
		<div class="label">资源类型: 
			<select name="rs_type" class="search_name">
				<option value="">请选择资源类型</option>
				<option value="doc">doc</option>
				<option value="script">script</option>
				<option value="img">img</option>
				<option value="css">css</option>
				<option value="xmlhttprequest">xmlhttprequest</option>
				<option value="other">other</option>
			</select>
		</div>
		<div class="label">RTT大于时间: <input name="duration" type="text" class="search_name" value="" placeholder="毫秒数" /></div>
		<div class="label">
			<span class="query" onclick="getFpList()">查询</span>&nbsp;
			<span class="query cancel" onclick="openCraetePop('#fp')">创建</span>
		</div>
	</div>

	<div class="form-box hide">
		<div>
			<div class="content">
				<div class="add-title">添加内容</div>
				<select name="app_name" class="search_name">
					<option value="">请选择</option>
					<option value="YouPin">优品</option>
					<option value="ZiYou">自有</option>
				</select>
				<input name="user_id" class="search_name" type="text" value="" placeholder="用户id或唯一标识" />
				<select name="rs_type" class="search_name">
					<option value="">请选择资源类型</option>
					<option value="doc">doc</option>
					<option value="script">script</option>
					<option value="img">img</option>
					<option value="css">css</option>
					<option value="xmlhttprequest">xmlhttprequest</option>
					<option value="other">other</option>
				</select>

				<input name="ready_start" class="search_name" type="text" value="" placeholder="准备新页面时间耗时" />
				<input name="redirect_time" class="search_name" type="text" value="" placeholder="redirect重定向耗时" />
				<input name="waiting_time" class="search_name" type="text" value="" placeholder="请求等待耗时" />
				<input name="unload_event_time" class="search_name" type="text" value="" placeholder="unload前文档耗时" />

				<input name="domain_time" class="search_name" type="text" value="" placeholder="DNS查询耗时" />
				<input name="conn_time" class="search_name" type="text" value="" placeholder="TCP连接耗时" />
				<input name="req_time" class="search_name" type="text" value="" placeholder="request请求耗时" />

				<input name="dom_tree_time" class="search_name" type="text" value="" placeholder="请求完毕至dom加载" />
				<input name="dom_ready_time" class="search_name" type="text" value="" placeholder="解析dom树耗时" />
				<input name="load_event_time" class="search_name" type="text" value="" placeholder="load事件耗时" />
				<input name="load_time" class="search_name" type="text" value="" placeholder="从开始至load总耗时" />
				<input name="duration" class="search_name" type="text" value="" placeholder="RTT" />

				<input name="format_size" class="search_name" type="text" value="" placeholder="资源大小" />
				<input name="file" class="search_name" type="text" value="" placeholder="资源路径" />
				<input name="method_type" class="search_name" type="text" value="" placeholder="加载方式" />
				<input name="network_type" class="search_name" type="text" value="" placeholder="网络情况,3g,4g,wifi,未知" />

				<div class="label">
					<span class="query" onclick="createPerformanceReport()">确定</span>&nbsp;
					<span class="query cancel" onclick="openCraetePop('#fp')">取消</span>
				</div>
			</div>
		</div>
	</div>

	<div id="fp-header"></div>
	<div id="fp-content"></div>
	<div id="fp-cheart" class="cheart"></div>
</div>

<script src="./js/jquery.min.js"></script>
<script src="./js/echarts.min.js"></script>
<script src="./js/analyses.js"></script>
<script>

ErrorReport.setConfig({
	api: "//analyses.huishoubao.com/api/v1/error-report",
	user_id: 'YSG123456',
	app_name: 'ZiYou'
})

Performance.setConfig({
	api: "//analyses.huishoubao.com/api/v1/performance-report",
	user_id: 'YSG123456',
	app_name: 'ZiYou'
})

let fe = {
	header: document.querySelector('#fe-header'),
	el: document.querySelector('#fe-content'),
	chart: document.querySelector('#fe-cheart'),
	dic: {
		user_id: '用户id',
		url: '错误url',
		file: '错误文件',
		line: '行号',
		message: '错误信息',
		stack: '错误栈',
		time: '上报时间'
	}
}

let node = {
	ready_start: '准备新页面时间耗时',
	redirect_time: 'redirect重定向耗时',
	waiting_time: '请求等待耗时',
	unload_event_time: 'unload前文档耗时',

	domain_time: 'DNS查询耗时',
	conn_time: 'TCP连接耗时',
	req_time: 'request请求耗时',

	dom_tree_time: '请求完毕至dom加载',
	dom_ready_time: '解析dom树耗时',
	load_event_time: 'load事件耗时',
	load_time: '从开始至load总耗时',
	duration: 'RTT',
}
let fp = {
	header: document.querySelector('#fp-header'),
	el: document.querySelector('#fp-content'),
	chart: document.querySelector('#fp-cheart'),

	dic: Object.assign({}, {
		app_name: '应用名',
		user_id: '用户id',
		city: '城市',
		time: '创建时间',

		rs_type: '资源类型',
	}, node, {
		format_size: '资源大小K',
		file: '资源路径',
		method_type: '加载方式',
		network_type: '网络情况'
	})
}

let ajax = (url, method, data) => {
	return new Promise((resolve, reject) => {
		$.ajax({
			url: `//analyses.huishoubao.com/api/v1/${url}`,
			type: method || 'GET',
			data: data,
			dataType: 'json',
			contentType: 'application/json',
			success: function (res = {}) {
				if (res.code === 0) {
					resolve(res.data)
				} else {
					resolve(res.msg)
				}
			},
			error: function (res) {
				reject(res)
			}
		});
	})
}

let docInner = (el, fields, data) => {
	let temp = []

	if (!data) {
		let htmls = []
		fields.forEach(field => {
			htmls.push(`<div class="row">${field}</div>`)
		})
		temp.push(`<div class="row-box header">${htmls.join('')}</div>`)
	} else {
		typeof data === 'object' && data.forEach(item => {
			let htmls = []
			let more = ""
			fields.forEach(field => {
				// 调用栈显示
				let text = item[field]
				let originText = text
				if (field === 'stack') {
					more = `<div class="row-box hide stack-row-box"><div class="row">${text}</div></div>`
					if (text) {
						text = text.slice(0, 40) + "..."
					}
				}

				// 文件路径||错误url
				if (field === 'file' || field === 'url') {
					if (text) {
						text = text.slice(0, 40) + "..."
					}
				}

				htmls.push(`<div class="row ${field}" title="${originText}">${typeof text === "undefined" ? '/' : text}</div>`)
			})
			temp.push(`<div class="row-box fe-click">${htmls.join('')}</div>`)
			if (more) {
				temp.push(more)
			}
		})
	}

	el.innerHTML = temp.join('');
}

let renderChart = (el, opt = {}) => {
	var myChart = echarts.init(el);
	myChart.setOption(opt, true);
}

let getFromName = (selectName) => {
	let list = document.querySelectorAll(selectName)
	let oVal = {}
	list.forEach(item => {
		oVal[item.name] = item.value
	})
	return oVal;
}

// 提交错误日志
let createErrorReport = async () => {
	let values = JSON.stringify(getFromName('#fe .form-box .search_name'))
	let res = await ajax('error-report', 'POST', values)
	openCraetePop('#fe')
}

// 获取错误列表
let getFeList = async () => {
	let res = await ajax('error-report', 'GET', getFromName('#fe .search .search_name'))
	docInner(fe.el, Object.keys(fe.dic), res)
	getFeChart()
}

// 获取错误-图表
let getFeChart = async () => {
	let oVal = Object.assign({}, getFromName('#fe .search .search_name'))
	let res = await ajax('error-report-chart', 'GET', oVal)
	if (typeof res === 'string') {
		renderChart(fe.chart)
		return alert(res)
	}

	let xAxis = [];

	let seriesData = []
	let series = [
		{
			name: '个数',
			type: 'bar',
			barWidth: '3%',
			data: seriesData
		}
	]
	res.forEach(item => {
		xAxis.push(item._id)
		seriesData.push(item.count)
	})

	let opt = {
		title: {
			text: ""
		},
		tooltip: {
			trigger: 'axis',
			axisPointer : { 
				type : 'shadow'
			}
		},
		legend: {
			data: []
		},
		grid: {
			left: '3%',
			right: '4%',
			bottom: '3%',
			containLabel: true
		},
		xAxis: {
			type : 'category',
			data : xAxis
		},
		yAxis: [
			{
				type : 'value'
			}
		],
		series: series
	};

	renderChart(fe.chart, opt)
}

// 提交资源性能
let createPerformanceReport = async () => {
	let values = getFromName('#fp .form-box .search_name')

	// 转成数字
	for (let i in values) {
		if (Number(values[i]) === Number(values[i])) {
			values[i] = Number(values[i])
		}
	}

	let data = {
		params: [values]
	}
	let res = await ajax('performance-report', 'POST', JSON.stringify(data))
	openCraetePop('#fp')
}

// 获取资源性能列表
let getFpList = async () => {
	let res = await ajax('performance-report', 'GET', getFromName('#fp .search .search_name'))
	docInner(fp.el, Object.keys(fp.dic), res)
	getFpChart()
}

// 获取资源性能-图表
let getFpChart = async () => {
	let oVal = Object.assign({}, getFromName('#fp .search .search_name'))
	let res = await ajax('performance-report-chart', 'GET', oVal)
	if (typeof res === 'string') {
		renderChart(fp.chart)
		return alert(res)
	}

	let series = []
	var temp = {}
	for (var i in res) {
		for (var j in res[i]) {
			if (!temp[j]) {
				temp[j] = []
			}

			temp[j].push(res[i][j])
		}
	}
	Object.keys(temp).forEach((item, index) => {
		series.push({
			name: item,
			type: 'bar',
			barWidth: '3%',
			data: Object.values(temp[item])
		})
	})

	let opt = {
		title: {
			text: ""
		},
		tooltip: {
			trigger: 'axis',
			axisPointer : { 
				type : 'shadow'
			}
		},
		legend: {
			type: 'scroll',
			right: 10,
			top: 0,
			bottom: 30,
			data: Object.keys(node),
		},
		grid: {
			left: '3%',
			right: '4%',
			bottom: '3%',
			containLabel: true
		},
		xAxis: [
			{
				type : 'category',
				data : Object.keys(res)
			}
		],
		yAxis: [
			{
				type : 'value'
			}
		],
		series: series
	};
	renderChart(fp.chart, opt)
}

// 打开新增内容层
let openCraetePop = (el) => {
	let formBox = document.querySelector(`${el} .form-box`)
	if (formBox.classList.contains('hide')) {
		return formBox.classList.remove('hide')
	}
	formBox.classList.add('hide')
}

docInner(fe.header, Object.values(fe.dic))
getFeList()
fe.el.addEventListener('click', (evt) => {
	if (evt.target.classList.contains('stack')) {
		let nextElement = evt.target.parentElement.nextElementSibling
		if (!nextElement) return;
		if (nextElement.classList.contains('hide')) {
			return nextElement.classList.remove('hide')
		}
		nextElement.classList.add('hide')
	}
}, false)

docInner(fp.header, Object.values(fp.dic))
getFpList()

if (Math.random() * 30 > 15) {
	setTimeout(() => {
		asdfasf()
	}, 1000)
}
</script>
</body>
</html>